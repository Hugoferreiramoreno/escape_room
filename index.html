<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Escape Rooms en Madrid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .filter-btn {
            transition: all 0.3s ease-in-out;
        }
        .filter-btn.active {
            background-color: #06b6d4;
            color: #ffffff;
            font-weight: 600;
        }
        .done {
            opacity: 0.6;
            background-color: #1f2937;
            transition: all 0.3s ease;
        }
        .done .text-content {
            text-decoration: line-through;
            text-decoration-color: #4b5563;
        }
        .room-item {
            transition: all 0.3s ease;
        }
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.3);
        }
        @keyframes checkmark {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .done-checkbox:checked {
            animation: checkmark 0.3s ease;
        }
        .star {
            cursor: pointer;
            transition: all 0.2s ease;
            color: #4b5563;
        }
        .star:hover, .star.filled {
            color: #fbbf24;
        }
        .like-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .like-btn.liked {
            color: #ef4444;
            transform: scale(1.1);
        }
        .like-btn:hover {
            transform: scale(1.2);
        }
        .sort-btn {
            transition: all 0.2s ease;
        }
        .sort-btn.active {
            background-color: #0891b2;
            color: white;
        }
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div class="container mx-auto px-4 py-12">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-cyan-400 mb-4">Checklist de Escape Rooms en Madrid</h1>
            <p class="text-lg text-gray-300 max-w-3xl mx-auto">Tu gu√≠a interactiva para conquistar las mejores salas de escapismo de la capital.</p>

            <!-- Estad√≠sticas -->
            <div class="mt-6 flex flex-wrap justify-center gap-4 text-sm">
                <div class="bg-gray-800 px-4 py-2 rounded-lg">
                    <span class="text-gray-400">Completadas:</span>
                    <span id="stats-done" class="text-cyan-400 font-bold ml-2">0/17</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded-lg">
                    <span class="text-gray-400">Progreso:</span>
                    <span id="stats-progress" class="text-cyan-400 font-bold ml-2">0%</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded-lg">
                    <span class="text-gray-400">Total Votos:</span>
                    <span id="stats-votes" class="text-amber-400 font-bold ml-2">0</span>
                </div>
                <div class="bg-gray-800 px-4 py-2 rounded-lg">
                    <span class="text-gray-400">üî• En vivo</span>
                </div>
                <button id="reset-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg transition-colors duration-200">
                    Resetear Progreso
                </button>
            </div>
        </header>

        <!-- Filtros y Ordenaci√≥n -->
        <div class="max-w-5xl mx-auto mb-10 space-y-4">
            <!-- Filtros de tipo -->
            <div id="filters" class="flex justify-center items-center gap-2 md:gap-4 bg-gray-800 p-2 rounded-lg">
                <button class="filter-btn active w-full md:w-auto text-center px-4 py-2 rounded-md bg-gray-700 hover:bg-cyan-600" data-filter="all">Todos</button>
                <button class="filter-btn w-full md:w-auto text-center px-4 py-2 rounded-md bg-gray-700 hover:bg-cyan-600" data-filter="fear">Miedo</button>
                <button class="filter-btn w-full md:w-auto text-center px-4 py-2 rounded-md bg-gray-700 hover:bg-cyan-600" data-filter="no-fear">Sin/Poco Miedo</button>
            </div>

            <!-- Ordenaci√≥n -->
            <div class="flex justify-center items-center gap-2 md:gap-4 bg-gray-800 p-2 rounded-lg flex-wrap">
                <span class="text-gray-400 text-sm">Ordenar por:</span>
                <button class="sort-btn active px-3 py-1 rounded-md bg-gray-700 hover:bg-cyan-700 text-sm" data-sort="rating">Nota Oficial</button>
                <button class="sort-btn px-3 py-1 rounded-md bg-gray-700 hover:bg-cyan-700 text-sm" data-sort="likes">üëç Me Gusta</button>
                <button class="sort-btn px-3 py-1 rounded-md bg-gray-700 hover:bg-cyan-700 text-sm" data-sort="stars">‚≠ê Estrellas</button>
                <button class="sort-btn px-3 py-1 rounded-md bg-gray-700 hover:bg-cyan-700 text-sm" data-sort="completed">üéØ M√°s Hechas</button>
            </div>
        </div>

        <!-- Listado de Escape Rooms -->
        <main id="escape-room-list" class="space-y-4 max-w-5xl mx-auto">
            <div class="text-center p-8"><p class="text-gray-400">Cargando datos...</p></div>
        </main>

        <footer class="text-center mt-12 text-gray-500">
            <p>&copy; 2024 - Gu√≠a de Escape Rooms Madrid. ¬°Disfruta de la aventura!</p>
            <p class="text-xs mt-2">Valoraciones basadas en <a href="https://www.gibaescape.com/ranking/ranking-salas-de-escape" target="_blank" class="text-cyan-400 hover:underline">GIBA ESCAPE</a> y otras fuentes</p>
        </footer>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDhHL5o7-Z8aXZLAhUPS5ZERFW2dYNoLwI",
            authDomain: "escape-room-4f60a.firebaseapp.com",
            databaseURL: "https://escape-room-4f60a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "escape-room-4f60a",
            storageBucket: "escape-room-4f60a.firebasestorage.app",
            messagingSenderId: "290104921130",
            appId: "1:290104921130:web:e5eea4e04ef7bc97a34753",
            measurementId: "G-5HM574CGXM"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const escapeRooms = [
            { id: 1, title: "La Santa", company: "Shock Creations", isFear: true, difficulty: "Muy Alta", fearLevel: "Extremo", time: "90 min", players: "2-6", price: "30-50‚Ç¨", rating: "10/10", summary: "Un demonio ha sido liberado en una antigua abad√≠a. La Iglesia os env√≠a como √∫ltima esperanza para realizar un exorcismo y salvar a las hermanas de una condena eterna.", bookingUrl: "https://www.shockescaperoom.com/" },
            { id: 17, title: "Viaje a Harrenfall", company: "MADLAND", isFear: false, difficulty: "Media", fearLevel: "Nulo", time: "150 min", players: "2-8", price: "35-55‚Ç¨", rating: "10/10", summary: "Emb√°rcate en una aventura √©pica por un reino de fantas√≠a medieval. Una experiencia inmersiva con decorados de pel√≠cula que te transportar√° a un mundo m√°gico lleno de secretos.", bookingUrl: "https://madlandmadrid.es/experiencias" },
            { id: 2, title: "Bites Motel", company: "Bite the Fly", isFear: true, difficulty: "Media-Alta", fearLevel: "Alto (Tensi√≥n)", time: "101 min", players: "2-8", price: "25-45‚Ç¨", rating: "9.8/10", summary: "Tu coche se aver√≠a y el √∫nico refugio es un motel de carretera regentado por un tipo... peculiar. Decides pasar la noche, sin saber que puede ser la √∫ltima.", bookingUrl: "https://www.bitethefly.es/bites-motel/" },
            { id: 4, title: "La Entrevista", company: "Cubick Escape", isFear: false, difficulty: "Media", fearLevel: "Medio (Psicol√≥gico)", time: "80 min", players: "2-5", price: "22-38‚Ç¨", rating: "9.8/10", summary: "Acudes a una entrevista de trabajo para una empresa misteriosa. Las pruebas de selecci√≥n pondr√°n a prueba no solo tu ingenio, sino tus nervios y tu moral.", bookingUrl: "https://cubickmadrid.es/" },
            { id: 5, title: "Paranormal Experience", company: "Madrid Terror", isFear: true, difficulty: "Alta", fearLevel: "Extremo", time: "90 min", players: "2-6", price: "28-48‚Ç¨", rating: "9.7/10", summary: "Construida sobre un antiguo matadero, la casa de un famoso cineasta es el epicentro del caso paranormal m√°s controvertido de la historia. Debes cerrarlo.", bookingUrl: "https://madridterror.com/" },
            { id: 18, title: "Proyecto DCrisis", company: "PARADISO", isFear: false, difficulty: "Alta", fearLevel: "Bajo (Tensi√≥n)", time: "90 min", players: "2-7", price: "25-45‚Ç¨", rating: "9.6/10", summary: "Formas parte de un equipo de exploraci√≥n espacial enviado a un planeta remoto. La misi√≥n: averiguar qu√© le ocurri√≥ a la tripulaci√≥n anterior. No est√°is solos.", bookingUrl: "https://paradisoescaperoom.com/" },
            { id: 13, title: "Diamante de Almas", company: "TERROR STORIES", isFear: true, difficulty: "Alta", fearLevel: "Muy Alto", time: "90 min", players: "4-8", price: "28-50‚Ç¨", rating: "9.5/10", summary: "La culminaci√≥n de una saga. Acud√≠s a la galer√≠a de un artista atormentado, donde su obra maestra, los 'Diamantes de Almas', revela un horror indescriptible.", bookingUrl: "https://terrorstories.es/" },
            { id: 6, title: "La Mina", company: "Hidden Escape", isFear: false, difficulty: "Media-Baja", fearLevel: "Bajo (Aventura)", time: "60 min", players: "2-6", price: "18-30‚Ç¨", rating: "9.5/10", summary: "Un valioso mineral se esconde en las profundidades de una mina abandonada. Desciende a las galer√≠as, resuelve los acertijos y escapa antes de que todo se derrumbe.", bookingUrl: "https://hiddenescaperoom.com/" },
            { id: 11, title: "La Novia", company: "BLACK LAKE", isFear: true, difficulty: "Alta", fearLevel: "Extremo", time: "90 min", players: "2-6", price: "25-45‚Ç¨", rating: "9.4/10", summary: "Un vidente siente una presencia en su casa que no es de este mundo. Vuestra misi√≥n es descubrir el oscuro secreto que se oculta tras el velo de 'La Novia'.", bookingUrl: "https://www.blacklakeescaperoom.com/lanovia" },
            { id: 19, title: "La Guarida de las G√°rgolas", company: "LA GUARIDA", isFear: false, difficulty: "Media", fearLevel: "Nulo", time: "100 min", players: "2-8", price: "19-32‚Ç¨", rating: "9.3/10", summary: "Unas antiguas g√°rgolas de piedra custodian un secreto ancestral. Ad√©ntrate en su guarida y demuestra ser digno de conocer su leyenda. Una aventura para toda la familia.", bookingUrl: "https://laguaridadelasgargolas.com/" },
            { id: 12, title: "La Coleccionista", company: "KALON", isFear: true, difficulty: "Media-Alta", fearLevel: "Alto", time: "80 min", players: "2-7", price: "22-40‚Ç¨", rating: "9.2/10", summary: "Una enigm√°tica coleccionista de objetos peculiares os ha invitado a su mansi√≥n. Pronto descubrir√©is que su colecci√≥n m√°s preciada sois vosotros.", bookingUrl: "https://www.kalonescaperoom.com/" },
            { id: 16, title: "MAGIC UNIVERSE", company: "MADLAND", isFear: false, difficulty: "Media", fearLevel: "Nulo", time: "75 min", players: "2-6", price: "20-38‚Ç¨", rating: "9.1/10", summary: "Ad√©ntrate en un universo m√°gico lleno de criaturas fant√°sticas y hechizos por descubrir. Una aventura √©pica para los amantes de la fantas√≠a.", bookingUrl: "https://madlandfestival.es/magic-universe/" },
            { id: 20, title: "El Laberinto", company: "DESCIFRA", isFear: false, difficulty: "Media-Alta", fearLevel: "Bajo (Misterio)", time: "80 min", players: "2-6", price: "21-36‚Ç¨", rating: "9.0/10", summary: "La mente de un genio es un lugar complejo y peligroso. Debes adentrarte en sus recuerdos para encontrarle antes de que se pierda para siempre en su propio laberinto mental.", bookingUrl: "https://descifra-escaperoom.es/" },
            { id: 14, title: "Jack el Destripador", company: "LA ORDEN", isFear: true, difficulty: "Media", fearLevel: "Alto", time: "75 min", players: "2-6", price: "20-35‚Ç¨", rating: "8.9/10", summary: "Londres, 1888. Un imitador del asesino m√°s famoso de la historia est√° sembrando el p√°nico. Seguid sus pasos por los callejones de Whitechapel y detenedlo.", bookingUrl: "https://laordenescape.com/jack-el-destripador/" },
            { id: 9, title: "Operaci√≥n Steampunk", company: "Incognito Escape", isFear: false, difficulty: "Media", fearLevel: "Nulo", time: "75 min", players: "2-6", price: "20-35‚Ç¨", rating: "8.9/10", summary: "Viaja a un universo retrofuturista de engranajes y vapor. Tu misi√≥n es infiltrarte en el taller de un inventor y robar los planos de su nueva y peligrosa m√°quina.", bookingUrl: "https://incognitoescape.es/" },
            { id: 15, title: "Pu√±alada", company: "FRIKI ESCAPE ROOM", isFear: true, difficulty: "Media-Alta", fearLevel: "Medio-Alto", time: "60 min", players: "2-5", price: "18-30‚Ç¨", rating: "8.7/10", summary: "Una noche de cine de terror se convierte en una pesadilla real. Alguien est√° replicando los cr√≠menes de la pel√≠cula y vosotros sois los protagonistas.", bookingUrl: "https://www.frikiescaperoom.es/" }
        ];

        // Variables globales
        const listContainer = document.getElementById('escape-room-list');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const sortButtons = document.querySelectorAll('.sort-btn');
        const resetBtn = document.getElementById('reset-btn');
        const statsDone = document.getElementById('stats-done');
        const statsProgress = document.getElementById('stats-progress');
        const statsVotes = document.getElementById('stats-votes');

        const defaultDoneIds = [1, 4, 6];
        let doneItems = JSON.parse(localStorage.getItem('doneEscapeRooms')) || defaultDoneIds;
        let currentFilter = 'all';
        let currentSort = 'rating';
        let votesData = {};

        // Funci√≥n para obtener ID √∫nico de usuario
        const getUserId = () => {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        };

        // Funciones Firebase
        const getVoteData = (roomId) => {
            return votesData[roomId] || { likes: 0, starTotal: 0, starCount: 0, completed: 0 };
        };

        const updateVote = async (roomId, field, increment) => {
            const ref = database.ref(`rooms/${roomId}/${field}`);
            try {
                await ref.transaction((current) => {
                    return (current || 0) + increment;
                });
            } catch (error) {
                console.error('Error updating vote:', error);
            }
        };

        const getUserVotes = () => {
            const votes = localStorage.getItem('userVotes');
            return votes ? JSON.parse(votes) : {};
        };

        const saveUserVotes = (votes) => {
            localStorage.setItem('userVotes', JSON.stringify(votes));
        };

        // Escuchar cambios en Firebase en tiempo real
        const listenToVotes = () => {
            database.ref('rooms').on('value', (snapshot) => {
                const data = snapshot.val() || {};
                votesData = {};

                Object.keys(data).forEach(roomId => {
                    votesData[roomId] = {
                        likes: data[roomId].likes || 0,
                        starTotal: data[roomId].starTotal || 0,
                        starCount: data[roomId].starCount || 0,
                        completed: data[roomId].completed || 0
                    };
                });

                // Solo re-renderizar si ya hemos hecho el render inicial
                if (listContainer.querySelector('.room-item')) {
                    renderEscapeRooms(currentFilter, currentSort);
                }
            });
        };

        // Actualizar estad√≠sticas
        const updateStats = () => {
            const total = escapeRooms.length;
            const done = doneItems.length;
            const progress = Math.round((done / total) * 100);

            statsDone.textContent = `${done}/${total}`;
            statsProgress.textContent = `${progress}%`;

            let totalVotes = 0;
            Object.values(votesData).forEach(data => {
                totalVotes += data.likes + data.starCount;
            });
            statsVotes.textContent = totalVotes;
        };

        // Renderizar escape rooms
        const renderEscapeRooms = (filter = 'all', sort = 'rating') => {
            let filteredRooms = escapeRooms.filter(room => {
                if (filter === 'all') return true;
                if (filter === 'fear') return room.isFear;
                if (filter === 'no-fear') return !room.isFear;
            });

            // A√±adir datos de votaci√≥n
            const roomsWithVotes = filteredRooms.map(room => {
                const voteData = getVoteData(room.id);
                const starAvg = voteData.starCount > 0 ? voteData.starTotal / voteData.starCount : 0;
                return {
                    ...room,
                    likes: voteData.likes,
                    starAverage: starAvg,
                    starCount: voteData.starCount,
                    completed: voteData.completed
                };
            });

            // Ordenar
            roomsWithVotes.sort((a, b) => {
                if (sort === 'rating') return b.rating.localeCompare(a.rating);
                if (sort === 'likes') return b.likes - a.likes;
                if (sort === 'stars') return b.starAverage - a.starAverage;
                if (sort === 'completed') return b.completed - a.completed;
                return 0;
            });

            listContainer.innerHTML = '';

            if(roomsWithVotes.length === 0){
                listContainer.innerHTML = `<div class="text-center p-8 bg-gray-800 rounded-lg"><p class="text-gray-400">No hay salas que coincidan con tu filtro.</p></div>`;
                return;
            }

            const userVotes = getUserVotes();

            roomsWithVotes.forEach(room => {
                const isDone = doneItems.includes(room.id);
                const doneClass = isDone ? 'done' : '';
                const checkedAttr = isDone ? 'checked' : '';

                const userLiked = userVotes[`like_${room.id}`] === true;
                const userStars = userVotes[`stars_${room.id}`] || 0;
                const likeClass = userLiked ? 'liked' : '';

                const roomElement = document.createElement('div');
                roomElement.className = `room-item bg-gray-800 rounded-lg border border-gray-700 overflow-hidden ${doneClass}`;
                roomElement.dataset.id = room.id;

                roomElement.innerHTML = `
                    <div class="flex flex-col">
                        <div class="flex-grow p-4">
                            <div class="text-content">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex-grow">
                                        <h2 class="text-xl font-bold text-cyan-400">
                                            <a href="${room.bookingUrl}" target="_blank" rel="noopener noreferrer" class="hover:underline">${room.title}</a>
                                        </h2>
                                        <p class="text-sm text-gray-400">${room.company}</p>
                                    </div>
                                    <div class="flex-shrink-0 ml-4 text-center">
                                        <div class="text-xl font-bold text-amber-400">${room.rating}</div>
                                        <div class="text-xs text-gray-400">Oficial</div>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-300 mb-3">${room.summary}</p>
                                <div class="details flex flex-wrap gap-x-4 gap-y-2 text-xs text-gray-300 mb-3">
                                    <span title="Dificultad">üìä ${room.difficulty}</span>
                                    <span title="Nivel de Miedo">üò± ${room.fearLevel}</span>
                                    <span title="Duraci√≥n">‚è±Ô∏è ${room.time}</span>
                                    <span title="Jugadores">üë• ${room.players}</span>
                                    <span title="Precio por persona">üí∞ ~${room.price}</span>
                                </div>
                            </div>

                            <!-- Secci√≥n de votaci√≥n -->
                            <div class="border-t border-gray-700 pt-3 mt-3">
                                <div class="flex flex-wrap items-center justify-between gap-3">
                                    <!-- Me gusta -->
                                    <div class="flex items-center gap-2">
                                        <button class="like-btn ${likeClass} text-2xl" data-id="${room.id}" title="Me gusta" ${userLiked ? 'disabled' : ''}>
                                            ${userLiked ? '‚ù§Ô∏è' : 'ü§ç'}
                                        </button>
                                        <span class="text-sm text-gray-400">${room.likes} me gusta</span>
                                    </div>

                                    <!-- Estrellas -->
                                    <div class="flex items-center gap-2">
                                        <div class="stars-container flex gap-1" data-id="${room.id}">
                                            ${[1,2,3,4,5].map(i => `<span class="star text-xl ${userStars >= i ? 'filled' : ''}" data-value="${i}" ${userStars > 0 ? 'style="cursor: not-allowed;"' : ''}>‚òÖ</span>`).join('')}
                                        </div>
                                        <span class="text-sm text-gray-400">
                                            ${room.starAverage > 0 ? `${room.starAverage.toFixed(1)}‚≠ê (${room.starCount})` : 'Sin votos'}
                                        </span>
                                    </div>

                                    <!-- Contador de completadas -->
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-400">üéØ ${room.completed} la hicieron</span>
                                    </div>

                                    <!-- Checkbox hecha -->
                                    <div class="flex items-center">
                                        <label for="done-${room.id}" class="text-xs text-gray-400 mr-2 cursor-pointer">Hecha</label>
                                        <input type="checkbox" id="done-${room.id}" data-id="${room.id}" class="done-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-cyan-500 focus:ring-cyan-600 cursor-pointer" ${checkedAttr}>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.appendChild(roomElement);
            });

            addInteractionListeners();
            updateStats();
        };

        // A√±adir listeners de interacci√≥n
        const addInteractionListeners = () => {
            // Checkboxes
            document.querySelectorAll('.done-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const id = parseInt(e.target.dataset.id);
                    const roomElement = e.target.closest('.room-item');

                    if (e.target.checked) {
                        if (!doneItems.includes(id)) {
                            doneItems.push(id);
                            await updateVote(id, 'completed', 1);
                        }
                        roomElement.classList.add('done');
                    } else {
                        doneItems = doneItems.filter(itemId => itemId !== id);
                        await updateVote(id, 'completed', -1);
                        roomElement.classList.remove('done');
                    }
                    localStorage.setItem('doneEscapeRooms', JSON.stringify(doneItems));
                });
            });

            // Like buttons
            document.querySelectorAll('.like-btn').forEach(btn => {
                if (btn.disabled) return;

                btn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const id = parseInt(e.currentTarget.dataset.id);
                    const userVotes = getUserVotes();
                    const voteKey = `like_${id}`;

                    if (!userVotes[voteKey]) {
                        btn.disabled = true;
                        btn.classList.add('loading');

                        await updateVote(id, 'likes', 1);
                        userVotes[voteKey] = true;
                        saveUserVotes(userVotes);

                        btn.classList.remove('loading');
                    }
                });
            });

            // Star rating
            document.querySelectorAll('.stars-container').forEach(container => {
                const stars = container.querySelectorAll('.star');
                const id = parseInt(container.dataset.id);
                const userVotes = getUserVotes();
                const voteKey = `stars_${id}`;

                if (userVotes[voteKey]) return; // Ya vot√≥

                stars.forEach(star => {
                    star.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const rating = parseInt(star.dataset.value);

                        if (!userVotes[voteKey]) {
                            container.classList.add('loading');

                            await updateVote(id, 'starTotal', rating);
                            await updateVote(id, 'starCount', 1);

                            userVotes[voteKey] = rating;
                            saveUserVotes(userVotes);

                            container.classList.remove('loading');
                        }
                    });

                    star.addEventListener('mouseenter', () => {
                        if (!userVotes[voteKey]) {
                            const value = parseInt(star.dataset.value);
                            stars.forEach((s, idx) => {
                                if (idx < value) {
                                    s.classList.add('filled');
                                } else {
                                    s.classList.remove('filled');
                                }
                            });
                        }
                    });
                });

                container.addEventListener('mouseleave', () => {
                    if (!userVotes[voteKey]) {
                        stars.forEach(s => s.classList.remove('filled'));
                    }
                });
            });
        };

        // Event listeners para filtros
        filterButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                filterButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentFilter = e.target.dataset.filter;
                renderEscapeRooms(currentFilter, currentSort);
            });
        });

        // Event listeners para ordenaci√≥n
        sortButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                sortButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentSort = e.target.dataset.sort;
                renderEscapeRooms(currentFilter, currentSort);
            });
        });

        // Reset button
        resetBtn.addEventListener('click', () => {
            if (confirm('¬øEst√°s seguro de que quieres resetear tu progreso? Esto NO borrar√° los votos de la comunidad, solo tus salas completadas.')) {
                doneItems = [];
                localStorage.setItem('doneEscapeRooms', JSON.stringify(doneItems));
                renderEscapeRooms(currentFilter, currentSort);
            }
        });

        // Inicializar
        listenToVotes();

        // Render inicial despu√©s de cargar datos
        setTimeout(() => {
            renderEscapeRooms();
        }, 500);
    </script>
</body>
</html>